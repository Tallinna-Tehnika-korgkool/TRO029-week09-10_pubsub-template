name: Week 09-10 Publisher/Subscriber Check

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main

jobs:
  validate-pubsub:
    runs-on: ubuntu-latest
    container:
      image: osrf/ros:humble-desktop
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup ROS2 Environment
        run: |
          echo "Setting up ROS2 Humble environment..."
          . /opt/ros/humble/setup.bash
          echo "ROS_DISTRO=$ROS_DISTRO"
          echo "‚úÖ ROS2 environment ready"

      - name: üìÇ Validate Package Structure
        id: structure_check
        run: |
          . /opt/ros/humble/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìÇ SAMM 1: Kontrollin py_pubsub paketi struktuuri"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          ERRORS=0
          SUCCESS=0
          
          PKG_NAME="py_pubsub"
          PKG_PATH="ros2_ws/src/$PKG_NAME"
          
          # Kontrolli workspace
          if [ -d "ros2_ws/src" ]; then
            echo "‚úÖ Workspace 'ros2_ws/src' olemas"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: Workspace 'ros2_ws/src' puudub"
            ((ERRORS++))
          fi
          
          # Kontrolli paketi kausta
          if [ -d "$PKG_PATH" ]; then
            echo "‚úÖ Pakett '$PKG_NAME' olemas"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: Pakett '$PKG_NAME' puudub"
            echo "   üìç Oodatud asukoht: $PKG_PATH"
            echo "   üí° Loo see: ros2 pkg create --build-type ament_python --license Apache-2.0 $PKG_NAME"
            ((ERRORS++))
            echo "STRUCTURE_ERRORS=$ERRORS" >> $GITHUB_ENV
            exit 1
          fi
          
          # Kontrolli package.xml
          if [ -f "$PKG_PATH/package.xml" ]; then
            echo "‚úÖ Fail 'package.xml' olemas"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: 'package.xml' puudub"
            ((ERRORS++))
          fi
          
          # Kontrolli setup.py
          if [ -f "$PKG_PATH/setup.py" ]; then
            echo "‚úÖ Fail 'setup.py' olemas"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: 'setup.py' puudub"
            ((ERRORS++))
          fi
          
          # Kontrolli Python paketi kausta
          if [ -d "$PKG_PATH/$PKG_NAME" ]; then
            echo "‚úÖ Python paketi kaust olemas: $PKG_NAME/$PKG_NAME/"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: Python paketi kaust puudub"
            ((ERRORS++))
          fi
          
          echo ""
          echo "STRUCTURE_ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "STRUCTURE_SUCCESS=$SUCCESS" >> $GITHUB_ENV
          
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: üìù Validate Node Files
        id: node_files_check
        if: success() || failure()
        run: |
          . /opt/ros/humble/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìù SAMM 2: Kontrollin node failide olemasolu"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          ERRORS=0
          SUCCESS=0
          
          PKG_NAME="py_pubsub"
          PKG_PATH="ros2_ws/src/$PKG_NAME/$PKG_NAME"
          
          # Kontrolli publisher faili
          PUB_FILE="$PKG_PATH/publisher_member_function.py"
          if [ -f "$PUB_FILE" ]; then
            echo "‚úÖ Publisher fail olemas: publisher_member_function.py"
            ((SUCCESS++))
            
            # Kontrolli kas fail sisaldab MinimalPublisher klassi
            if grep -q "class MinimalPublisher" "$PUB_FILE"; then
              echo "   ‚úì Sisaldab MinimalPublisher klassi"
              ((SUCCESS++))
            else
              echo "   ‚ö†Ô∏è HOIATUS: Ei leia MinimalPublisher klassi"
            fi
            
            # Kontrolli kas on main funktsioon
            if grep -q "def main" "$PUB_FILE"; then
              echo "   ‚úì Sisaldab main() funktsiooni"
              ((SUCCESS++))
            else
              echo "   ‚ùå VIGA: Puudub main() funktsioon"
              ((ERRORS++))
            fi
          else
            echo "‚ùå VIGA: Publisher fail puudub: publisher_member_function.py"
            echo "   üìç Oodatud asukoht: $PUB_FILE"
            echo "   üí° Laadi alla n√§itefail wget k√§suga (vaata README)"
            ((ERRORS++))
          fi
          
          echo ""
          
          # Kontrolli subscriber faili
          SUB_FILE="$PKG_PATH/subscriber_member_function.py"
          if [ -f "$SUB_FILE" ]; then
            echo "‚úÖ Subscriber fail olemas: subscriber_member_function.py"
            ((SUCCESS++))
            
            # Kontrolli kas fail sisaldab MinimalSubscriber klassi
            if grep -q "class MinimalSubscriber" "$SUB_FILE"; then
              echo "   ‚úì Sisaldab MinimalSubscriber klassi"
              ((SUCCESS++))
            else
              echo "   ‚ö†Ô∏è HOIATUS: Ei leia MinimalSubscriber klassi"
            fi
            
            # Kontrolli kas on main funktsioon
            if grep -q "def main" "$SUB_FILE"; then
              echo "   ‚úì Sisaldab main() funktsiooni"
              ((SUCCESS++))
            else
              echo "   ‚ùå VIGA: Puudub main() funktsioon"
              ((ERRORS++))
            fi
          else
            echo "‚ùå VIGA: Subscriber fail puudub: subscriber_member_function.py"
            echo "   üìç Oodatud asukoht: $SUB_FILE"
            echo "   üí° Laadi alla n√§itefail wget k√§suga (vaata README)"
            ((ERRORS++))
          fi
          
          echo ""
          echo "NODE_FILES_ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "NODE_FILES_SUCCESS=$SUCCESS" >> $GITHUB_ENV
          
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: üîç Validate Dependencies
        id: dependencies_check
        if: success() || failure()
        run: |
          . /opt/ros/humble/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîç SAMM 3: Kontrollin s√µltuvusi (package.xml)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          ERRORS=0
          SUCCESS=0
          WARNINGS=0
          
          PKG_PATH="ros2_ws/src/py_pubsub"
          PACKAGE_XML="$PKG_PATH/package.xml"
          
          if [ ! -f "$PACKAGE_XML" ]; then
            echo "‚ùå VIGA: package.xml puudub"
            ((ERRORS++))
            echo "DEPENDENCIES_ERRORS=$ERRORS" >> $GITHUB_ENV
            exit 1
          fi
          
          # Kontrolli rclpy
          if grep -q "<exec_depend>rclpy</exec_depend>" "$PACKAGE_XML" || \
             grep -q "<depend>rclpy</depend>" "$PACKAGE_XML"; then
            echo "‚úÖ S√µltuvus 'rclpy' deklareeritud"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: S√µltuvus 'rclpy' puudub"
            echo "   üí° Lisa: <exec_depend>rclpy</exec_depend>"
            ((ERRORS++))
          fi
          
          # Kontrolli std_msgs
          if grep -q "<exec_depend>std_msgs</exec_depend>" "$PACKAGE_XML" || \
             grep -q "<depend>std_msgs</depend>" "$PACKAGE_XML"; then
            echo "‚úÖ S√µltuvus 'std_msgs' deklareeritud"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: S√µltuvus 'std_msgs' puudub"
            echo "   üí° Lisa: <exec_depend>std_msgs</exec_depend>"
            ((ERRORS++))
          fi
          
          # Kontrolli metaandmeid
          echo ""
          echo "üìã Kontrollin metaandmeid..."
          
          if grep -q "<description>.*TODO.*</description>" "$PACKAGE_XML" || \
             grep -q "<description></description>" "$PACKAGE_XML"; then
            echo "‚ö†Ô∏è HOIATUS: Description t√§itmata v√µi sisaldab 'TODO'"
            ((WARNINGS++))
          else
            echo "‚úÖ Description t√§idetud"
            ((SUCCESS++))
          fi
          
          if grep -q 'maintainer email=".*TODO.*"' "$PACKAGE_XML" || \
             grep -q 'maintainer email="">.*</maintainer>' "$PACKAGE_XML"; then
            echo "‚ö†Ô∏è HOIATUS: Maintainer email t√§itmata"
            ((WARNINGS++))
          else
            echo "‚úÖ Maintainer email t√§idetud"
            ((SUCCESS++))
          fi
          
          echo ""
          echo "DEPENDENCIES_ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "DEPENDENCIES_SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "DEPENDENCIES_WARNINGS=$WARNINGS" >> $GITHUB_ENV
          
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: üîß Validate Entry Points
        id: entry_points_check
        if: success() || failure()
        run: |
          . /opt/ros/humble/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîß SAMM 4: Kontrollin entry_points (setup.py)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          ERRORS=0
          SUCCESS=0
          
          SETUP_PY="ros2_ws/src/py_pubsub/setup.py"
          
          if [ ! -f "$SETUP_PY" ]; then
            echo "‚ùå VIGA: setup.py puudub"
            ((ERRORS++))
            echo "ENTRY_POINTS_ERRORS=$ERRORS" >> $GITHUB_ENV
            exit 1
          fi
          
          # Kontrolli talker
          if grep -q "talker.*=.*py_pubsub.publisher_member_function:main" "$SETUP_PY"; then
            echo "‚úÖ Entry point 'talker' korrektne"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: Entry point 'talker' puudub v√µi vale"
            echo "   üí° Lisa: 'talker = py_pubsub.publisher_member_function:main',"
            ((ERRORS++))
          fi
          
          # Kontrolli listener
          if grep -q "listener.*=.*py_pubsub.subscriber_member_function:main" "$SETUP_PY"; then
            echo "‚úÖ Entry point 'listener' korrektne"
            ((SUCCESS++))
          else
            echo "‚ùå VIGA: Entry point 'listener' puudub v√µi vale"
            echo "   üí° Lisa: 'listener = py_pubsub.subscriber_member_function:main',"
            ((ERRORS++))
          fi
          
          echo ""
          echo "ENTRY_POINTS_ERRORS=$ERRORS" >> $GITHUB_ENV
          echo "ENTRY_POINTS_SUCCESS=$SUCCESS" >> $GITHUB_ENV
          
          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: üî® Build Package
        id: build_check
        if: success() || failure()
        run: |
          . /opt/ros/humble/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üî® SAMM 5: Kompileerin py_pubsub paketti"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          cd ros2_ws
          
          if colcon build --packages-select py_pubsub 2>&1 | tee build.log; then
            echo ""
            echo "‚úÖ Build √µnnestus!"
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
          else
            echo ""
            echo "‚ùå Build eba√µnnestus!"
            echo ""
            echo "üìã VIIMASED VEAREAD:"
            tail -n 30 build.log
            echo ""
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: üöÄ Test Publisher Node
        id: publisher_test
        if: env.BUILD_SUCCESS == 'true'
        run: |
          . /opt/ros/humble/setup.bash
          cd ros2_ws
          . install/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üöÄ SAMM 6: Testin Publisher (talker)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # K√§ivita publisher 3 sekundiks
          timeout 3s ros2 run py_pubsub talker > pub.txt 2>&1 &
          PUB_PID=$!
          
          sleep 1
          
          if ps -p $PUB_PID > /dev/null 2>&1; then
            echo "‚úÖ Publisher k√§ivitus!"
            
            sleep 1
            
            # Kontrolli topic'ut
            if ros2 topic list 2>/dev/null | grep -q "/topic"; then
              echo "‚úÖ Topic '/topic' eksisteerib"
              
              TOPIC_TYPE=$(ros2 topic type /topic 2>/dev/null)
              echo "   Topic type: $TOPIC_TYPE"
              
              if echo "$TOPIC_TYPE" | grep -q "std_msgs/msg/String"; then
                echo "‚úÖ Korrektne message type"
              fi
            else
              echo "‚ùå VIGA: Topic '/topic' ei leitud"
              kill $PUB_PID 2>/dev/null || true
              echo "PUBLISHER_SUCCESS=false" >> $GITHUB_ENV
              exit 1
            fi
            
            kill $PUB_PID 2>/dev/null || true
            wait $PUB_PID 2>/dev/null || true
            
            echo "PUBLISHER_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "‚ùå Publisher ei k√§ivitunud"
            cat pub.txt 2>/dev/null || true
            echo "PUBLISHER_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: üì° Test Subscriber Node
        id: subscriber_test
        if: env.BUILD_SUCCESS == 'true'
        run: |
          . /opt/ros/humble/setup.bash
          cd ros2_ws
          . install/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì° SAMM 7: Testin Subscriber (listener)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # K√§ivita subscriber 3 sekundiks
          timeout 3s ros2 run py_pubsub listener > sub.txt 2>&1 &
          SUB_PID=$!
          
          sleep 1
          
          if ps -p $SUB_PID > /dev/null 2>&1; then
            echo "‚úÖ Subscriber k√§ivitus!"
            
            kill $SUB_PID 2>/dev/null || true
            wait $SUB_PID 2>/dev/null || true
            
            echo "SUBSCRIBER_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "‚ùå Subscriber ei k√§ivitunud"
            cat sub.txt 2>/dev/null || true
            echo "SUBSCRIBER_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: üîÑ Test Communication
        id: communication_test
        if: env.BUILD_SUCCESS == 'true' && env.PUBLISHER_SUCCESS == 'true' && env.SUBSCRIBER_SUCCESS == 'true'
        run: |
          . /opt/ros/humble/setup.bash
          cd ros2_ws
          . install/setup.bash
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîÑ SAMM 8: Testin suhtlust"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # K√§ivita m√µlemad
          ros2 run py_pubsub talker > /dev/null 2>&1 &
          PUB_PID=$!
          
          sleep 0.5
          
          ros2 run py_pubsub listener > comm_sub.txt 2>&1 &
          SUB_PID=$!
          
          sleep 3
          
          kill $PUB_PID $SUB_PID 2>/dev/null || true
          wait $PUB_PID $SUB_PID 2>/dev/null || true
          
          if [ -s "comm_sub.txt" ]; then
            if grep -qi "I heard" comm_sub.txt || grep -qi "Hello" comm_sub.txt; then
              echo "‚úÖ Subscriber sai s√µnumeid!"
              echo ""
              echo "üìã N√§idis:"
              head -n 3 comm_sub.txt
            else
              echo "‚ö†Ô∏è Subscriber t√∂√∂tab, aga s√µnumeid pole kindel"
            fi
            echo "COMMUNICATION_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "‚ùå Suhtlus eba√µnnestus"
            echo "COMMUNICATION_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: üìä Final Report
        if: always()
        run: |
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä KOKKUV√ïTE - Week 09-10"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          [ "${STRUCTURE_ERRORS:-0}" -eq 0 ] && echo "‚úÖ Struktuur: OK" || echo "‚ùå Struktuur: VIGA"
          [ "${NODE_FILES_ERRORS:-0}" -eq 0 ] && echo "‚úÖ Node failid: OK" || echo "‚ùå Node failid: VIGA"
          [ "${DEPENDENCIES_ERRORS:-0}" -eq 0 ] && echo "‚úÖ S√µltuvused: OK" || echo "‚ùå S√µltuvused: VIGA"
          [ "${ENTRY_POINTS_ERRORS:-0}" -eq 0 ] && echo "‚úÖ Entry points: OK" || echo "‚ùå Entry points: VIGA"
          [ "${BUILD_SUCCESS:-false}" == "true" ] && echo "‚úÖ Build: OK" || echo "‚ùå Build: FAIL"
          [ "${PUBLISHER_SUCCESS:-false}" == "true" ] && echo "‚úÖ Publisher: OK" || echo "‚ùå Publisher: FAIL"
          [ "${SUBSCRIBER_SUCCESS:-false}" == "true" ] && echo "‚úÖ Subscriber: OK" || echo "‚ùå Subscriber: FAIL"
          [ "${COMMUNICATION_SUCCESS:-false}" == "true" ] && echo "‚úÖ Suhtlus: OK" || echo "‚ö†Ô∏è Suhtlus: ?"
          
          echo ""
          
          TOTAL_ERRORS=$((${STRUCTURE_ERRORS:-0} + ${NODE_FILES_ERRORS:-0} + ${DEPENDENCIES_ERRORS:-0} + ${ENTRY_POINTS_ERRORS:-0}))
          
          if [ "$TOTAL_ERRORS" -eq 0 ] && \
             [ "${BUILD_SUCCESS:-false}" == "true" ] && \
             [ "${PUBLISHER_SUCCESS:-false}" == "true" ] && \
             [ "${SUBSCRIBER_SUCCESS:-false}" == "true" ]; then
            echo "üéâ PALJU √ïNNE! K√µik testid l√§bitud!"
            echo ""
            echo "üìö J√§rgmine: Week 11-12 (Services)"
          else
            echo "‚ùå √úLESANNE VAJAB PARANDAMIST"
            echo ""
            echo "Vaata √ºlalpool punaseid vigu ja paranda need"
          fi

      - name: üìù GitHub Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üìä Week 09-10: Publisher/Subscriber
          
          | Samm | Tulemus |
          |------|---------|
          | üìÇ Struktuur | ${{ env.STRUCTURE_ERRORS == '0' && '‚úÖ' || '‚ùå' }} |
          | üìù Node failid | ${{ env.NODE_FILES_ERRORS == '0' && '‚úÖ' || '‚ùå' }} |
          | üîç S√µltuvused | ${{ env.DEPENDENCIES_ERRORS == '0' && '‚úÖ' || '‚ùå' }} |
          | üîß Entry points | ${{ env.ENTRY_POINTS_ERRORS == '0' && '‚úÖ' || '‚ùå' }} |
          | üî® Build | ${{ env.BUILD_SUCCESS == 'true' && '‚úÖ' || '‚ùå' }} |
          | üöÄ Publisher | ${{ env.PUBLISHER_SUCCESS == 'true' && '‚úÖ' || '‚ùå' }} |
          | üì° Subscriber | ${{ env.SUBSCRIBER_SUCCESS == 'true' && '‚úÖ' || '‚ùå' }} |
          | üîÑ Suhtlus | ${{ env.COMMUNICATION_SUCCESS == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} |
          
          ### Kui test eba√µnnestus:
          1. Vaata detailset logi √ºlalpool
          2. Paranda vead
          3. Push uuesti
          EOF